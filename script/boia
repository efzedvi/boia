#!/usr/bin/perl
use strict;
use warnings;

use Getopt::Long;
use Proc::PID::File;
use Proc::Daemon;
use Pod::Usage;

#remove before going into production
BEGIN { push @INC, '../lib'; };

use BOIA;

my $help_flag;
my $version_flag;
my $daemon_flag;
my $config_file = '/etc/boia.conf';
my $act_flag;
my $dryrun_flag;
my $parse_flag;
my $reload_flag;
my $zap_flag;
my $nozap_flag;

my $data   = "file.dat";
my $length = 24;
my $verbose;

my $res = GetOptions (	"help|?"	=> \$help_flag,
			"version|v"	=> \$version_flag,
			"daemon|d"	=> \$daemon_flag,
			"config|c=s"	=> \$config_file,
			"act|a"		=> \$act_flag,
			"dryrun|t"	=> \$dryrun_flag,
			"parse|p"	=> \$parse_flag,
			"reload|r"	=> \$reload_flag,
			"zap|z"		=> \$zap_flag,
			"nozap|n"	=> \$nozap_flag,
	);

pod2usage(1) unless $res;
pod2usage(0) if $help_flag;

my $boia = BOIA->new($config_file);

if ($version_flag) {
	print $boia->version."\n";
	exit;
}

my $work_dir = $boia->get_cfg()->get('workdir');
my $errors = $boia->get_cfg()->parse()->{errors};
for my $error (@$errors) {
	print STDERR "$error\n";
}
exit(1) if (scalar(@$errors));

exit(0) if $parse_flag; # my job is done

if ($zap_flag) {
	$boia->zap();
}

if ($reload_flag) {
	my $pid = Proc::PID::File->new({ dir => $work_dir });
	open(PID, $pid->{path}) || die qq/Cannot open pid file "$pid->{path}": $!\n/;
	my ($pid) = <PID> =~ /^(\d+)/;
	close PID;
	kill HUP, $pid if $pid;
	exit;
}

die "Already running!" if Proc::PID::File->running({ dir => $work_dir, verify => 1 });

if ($daemon_flag) {
	Proc::Daemon::Init;
	$SIG{'INT'} = \&bailout;
	$SIG{'HUP'} = \&reconf;
	$SIG{CHLD} = 'IGNORE';

	my $pid = Proc::PID::File->new({ dir => $workdir, verify => 1 });
	$pid->touch();
}
 
$SIG{'INT'} = \&bailout;
$SIG{'HUP'} = \&reconf;

if ($act_flag || $dryrun_flag) {
	$boia->scan_files();
} else {
	$boia->run(!$daemon_flag);
}

sub reconf {
        $boia->read_config();
}

sub bailout {
        $boia->exit_loop();
}


__END__

=head1 NAME

boia - Block/Ban Offending IP Addresses

=head1 SYNOPSIS

boia [options] :

Where the options are:

-h, -v (version), -d (daemon), -c <config_file> (default /etc/boia.conf)

-a (act; find and add bad IPs in non daemon mode and then exit)

-t (dry run; only detects and reports bad IPs)

-p (parses the config file)

-r (reload; signals the daemon to reread the config file if all is good)

-z (delete/zap; removes/unlbocks all the bad IPs it has found)

-n (nozap; do not zap/delete at the beginning, don't run zapcmd when it first starts)


=head1 OPTIONS

=over 8

=item B<-help>

Print a brief help message and exits.

=back

=head1 DESCRIPTION

B<This program> will read the given input file(s) and do someting
useful with the contents thereof.

=cut

